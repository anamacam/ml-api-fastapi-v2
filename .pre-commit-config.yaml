# ğŸ”§ Pre-commit Configuration - ML API FastAPI v2
# Este archivo configura hooks que se ejecutan antes de cada commit
# Para instalar: pip install pre-commit && pre-commit install

repos:
  # ==========================================
  # ğŸ” HOOKS GENERALES
  # ==========================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      # Archivos
      - id: trailing-whitespace
        name: "ğŸ§¹ Eliminar espacios al final"
      - id: end-of-file-fixer
        name: "ğŸ“ Arreglar final de archivo"
      - id: check-added-large-files
        name: "ğŸ“¦ Verificar archivos grandes"
        args: ["--maxkb=10000"] # 10MB mÃ¡ximo

      # Formato
      - id: check-yaml
        name: "ğŸ“‹ Verificar YAML"
        exclude: ^docs/
      - id: check-json
        name: "ğŸ” Verificar JSON"
      - id: check-toml
        name: "âš™ï¸ Verificar TOML"
      - id: check-xml
        name: "ğŸ“„ Verificar XML"

      # Git
      - id: check-merge-conflict
        name: "ğŸ”€ Verificar conflictos merge"
      - id: check-case-conflict
        name: "ğŸ“ Verificar conflictos case"

      # Seguridad bÃ¡sica
      - id: detect-private-key
        name: "ğŸ” Detectar claves privadas"
      - id: check-executables-have-shebangs
        name: "ğŸ“œ Verificar shebangs"

  # ==========================================
  # ğŸ PYTHON / BACKEND
  # ==========================================

  # Black - Formateo de cÃ³digo
  - repo: https://github.com/psf/black
    rev: 24.10.0
    hooks:
      - id: black
        name: "ğŸ–¤ Black - Formateo Python"
        files: ^backend/.*\.py$
        args: [--line-length=88, --target-version=py311]

  # isort - Ordenar imports
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: "ğŸ“š isort - Ordenar imports"
        files: ^backend/.*\.py$
        args: [--profile=black, --line-length=88]

  # Flake8 - Linting
  - repo: https://github.com/pycqa/flake8
    rev: 7.1.1
    hooks:
      - id: flake8
        name: "ğŸ” Flake8 - Linting Python"
        files: ^backend/.*\.py$
        args:
          [
            --max-line-length=88,
            --extend-ignore=E203,
            W503,
            E501,
            --max-complexity=10,
          ]
        additional_dependencies:
          - flake8-docstrings
          - flake8-import-order
          - flake8-bugbear

  # MyPy - Type checking
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.13.0
    hooks:
      - id: mypy
        name: "ğŸ¯ MyPy - Type checking"
        files: ^backend/app/.*\.py$
        args: [--ignore-missing-imports, --follow-imports=skip]
        additional_dependencies:
          - types-requests
          - types-redis

  # Bandit - Seguridad Python
  - repo: https://github.com/pycqa/bandit
    rev: 1.7.10
    hooks:
      - id: bandit
        name: "ğŸ›¡ï¸ Bandit - Seguridad Python"
        files: ^backend/.*\.py$
        args: [-r, -f, json, -o, bandit-report.json]
        exclude: ^backend/tests/.*

  # ==========================================
  # ğŸŒ JAVASCRIPT / TYPESCRIPT / FRONTEND
  # ==========================================

  # ESLint - Linting JS/TS
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v9.18.0
    hooks:
      - id: eslint
        name: "ğŸ” ESLint - Linting JS/TS"
        files: ^frontend/.*\.(js|jsx|ts|tsx)$
        types: [file]
        args: [--fix, --max-warnings=0]
        additional_dependencies:
          - eslint@^9.18.0
          - "@typescript-eslint/eslint-plugin@^8.20.0"
          - "@typescript-eslint/parser@^8.20.0"
          - "eslint-plugin-react@^7.37.2"
          - "eslint-plugin-react-hooks@^5.1.0"

  # Prettier - Formateo JS/TS
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: "ğŸ’… Prettier - Formateo JS/TS/CSS"
        files: ^frontend/.*\.(js|jsx|ts|tsx|css|scss|json|md)$
        args: [--write, --config, frontend/web-app/.prettierrc]

  # ==========================================
  # ğŸ³ DOCKER
  # ==========================================

  # Hadolint - Linting Dockerfiles
  - repo: https://github.com/hadolint/hadolint
    rev: v2.12.0
    hooks:
      - id: hadolint-docker
        name: "ğŸ³ Hadolint - Linting Dockerfiles"
        files: Dockerfile.*
        args: [--ignore, DL3008, --ignore, DL3009]

  # ==========================================
  # ğŸ“ DOCUMENTACIÃ“N
  # ==========================================

  # Markdownlint - Linting Markdown
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.42.0
    hooks:
      - id: markdownlint
        name: "ğŸ“ Markdownlint - Linting Markdown"
        files: \.md$
        args: [--fix, --config, .markdownlint.json]

  # ==========================================
  # ğŸ”§ CONFIGURACIÃ“N ESPECÃFICA
  # ==========================================

  # Yamllint - Linting YAML avanzado
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.35.1
    hooks:
      - id: yamllint
        name: "ğŸ“‹ Yamllint - Linting YAML avanzado"
        args: [-c, .yamllint.yaml]

  # Check requirements.txt
  - repo: https://github.com/Lucas-C/pre-commit-hooks
    rev: v1.5.5
    hooks:
      - id: remove-tabs
        name: "ğŸš« Eliminar tabs"
        files: ^backend/requirements/.*\.txt$

  # Security check for requirements
  - repo: https://github.com/Lucas-C/pre-commit-hooks-safety
    rev: v1.3.2
    hooks:
      - id: python-safety-dependencies-check
        name: "ğŸ›¡ï¸ Safety - Verificar dependencias vulnerables"
        files: ^backend/requirements/.*\.txt$

  # ==========================================
  # ğŸ”¬ TESTS
  # ==========================================

  # Pytest - Ejecutar tests crÃ­ticos
  - repo: local
    hooks:
      - id: pytest-fast
        name: "ğŸ§ª Pytest - Tests rÃ¡pidos"
        entry: bash -c 'cd backend && python -m pytest tests/unit/ -x --tb=short'
        language: system
        files: ^backend/.*\.py$
        pass_filenames: false

  # ==========================================
  # ğŸ” HOOKS LOCALES PERSONALIZADOS
  # ==========================================

  - repo: local
    hooks:
      # Verificar que no hay print() en producciÃ³n
      - id: no-print-statements
        name: "ğŸš« No print() en cÃ³digo"
        entry: bash -c 'if grep -r "print(" backend/app/ --include="*.py"; then echo "âŒ Encontrados print() statements en cÃ³digo de producciÃ³n"; exit 1; fi'
        language: system
        files: ^backend/app/.*\.py$
        pass_filenames: false

      # Verificar que hay docstrings en funciones pÃºblicas
      - id: check-docstrings
        name: "ğŸ“– Verificar docstrings"
        entry: bash -c 'python infrastructure/scripts/check_docstrings.py'
        language: system
        files: ^backend/app/.*\.py$
        pass_filenames: false

      # Verificar variables de entorno requeridas
      - id: check-env-vars
        name: "ğŸ”§ Verificar variables de entorno"
        entry: bash -c 'python infrastructure/scripts/check_env_vars.py'
        language: system
        files: ^(backend/app/core/config\.py|config/.*\.env)$
        pass_filenames: false

      # Verificar que package.json tiene las versiones correctas
      - id: check-package-versions
        name: "ğŸ“¦ Verificar versiones package.json"
        entry: bash -c 'python infrastructure/scripts/check_package_versions.py'
        language: system
        files: ^frontend/.*/package\.json$
        pass_filenames: false

# ==========================================
# âš™ï¸ CONFIGURACIÃ“N GLOBAL
# ==========================================
default_language_version:
  python: python3.11
  node: "18.19.0"

# ConfiguraciÃ³n de staging
default_stages: [commit, push]

# Excluir archivos
exclude: |
  (?x)^(
    backend/venv/.*|
    backend/\.venv/.*|
    frontend/.*/node_modules/.*|
    frontend/.*/dist/.*|
    frontend/.*/build/.*|
    data/.*|
    \.git/.*|
    .*\.min\.(js|css)$|
    .*\.bundle\.(js|css)$
  )$

# ConfiguraciÃ³n de CI
ci:
  autofix_commit_msg: |
    ğŸ¤– [pre-commit.ci] auto fixes from pre-commit hooks

    Para mÃ¡s informaciÃ³n, ver https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ""
  autoupdate_commit_msg: "ğŸ¤– [pre-commit.ci] pre-commit autoupdate"
  autoupdate_schedule: weekly
  skip: [pytest-fast, check-docstrings, check-env-vars, check-package-versions]
  submodules: false
