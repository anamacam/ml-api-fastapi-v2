# ======================================
# ğŸš€ ML API FastAPI v2 - Makefile
# ======================================

.PHONY: help install test tdd quality clean lint format setup check-all

# Variables
PYTHON = python
PIP = pip
PYTEST = pytest
PROJECT_ROOT = .
BACKEND_ROOT = backend

# Color codes for output
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

# ======================================
# ğŸ“‹ HELP - Comandos disponibles
# ======================================
help:
	@echo "ğŸš€ ML API FastAPI v2 - Comandos Disponibles"
	@echo "=========================================="
	@echo ""
	@echo "ğŸ”§ $(GREEN)Setup y InstalaciÃ³n:$(NC)"
	@echo "  make setup     - ConfiguraciÃ³n inicial completa"
	@echo "  make install   - Instalar dependencias"
	@echo ""
	@echo "ğŸ§ª $(GREEN)Testing y TDD:$(NC)"
	@echo "  make test      - Ejecutar todos los tests"
	@echo "  make tdd       - Ejecutar tests en modo TDD (watch)"
	@echo "  make coverage  - Generar reporte de cobertura"
	@echo ""
	@echo "ğŸ” $(GREEN)Calidad de CÃ³digo:$(NC)"
	@echo "  make quality   - Ejecutar checklist de calidad completo"
	@echo "  make lint      - Ejecutar linters (flake8)"
	@echo "  make format    - Formatear cÃ³digo (black)"
	@echo "  make check-all - Ejecutar todos los checks de calidad"
	@echo ""
	@echo "ğŸ§¹ $(GREEN)Limpieza:$(NC)"
	@echo "  make clean     - Limpiar archivos temporales"
	@echo ""

# ======================================
# ğŸ”§ SETUP Y INSTALACIÃ“N
# ======================================
setup: clean install
	@echo "$(GREEN)âœ… Setup completo realizado$(NC)"

install:
	@echo "$(YELLOW)ğŸ“¦ Instalando dependencias...$(NC)"
	cd $(BACKEND_ROOT) && $(PIP) install -r requirements/base.txt
	cd $(BACKEND_ROOT) && $(PIP) install -r requirements/test.txt
	@echo "$(GREEN)âœ… Dependencias instaladas$(NC)"

# ======================================
# ğŸ§ª TESTING Y TDD
# ======================================
test:
	@echo "$(YELLOW)ğŸ§ª Ejecutando tests...$(NC)"
	cd $(BACKEND_ROOT) && $(PYTEST) -v
	@echo "$(GREEN)âœ… Tests completados$(NC)"

tdd:
	@echo "$(YELLOW)ğŸ”„ Modo TDD activado (Ctrl+C para salir)...$(NC)"
	cd $(BACKEND_ROOT) && $(PYTEST) -f --tb=short

coverage:
	@echo "$(YELLOW)ğŸ“Š Generando reporte de cobertura...$(NC)"
	cd $(BACKEND_ROOT) && $(PYTEST) --cov=app --cov-report=html --cov-report=term
	@echo "$(GREEN)âœ… Reporte de cobertura generado en htmlcov/$(NC)"

# ======================================
# ğŸ” CALIDAD DE CÃ“DIGO
# ======================================
quality:
	@echo "$(YELLOW)ğŸ” Ejecutando Checklist de Calidad Automatizado...$(NC)"
	cd $(BACKEND_ROOT) && $(PYTHON) infrastructure/scripts/quick_quality.py
	@echo "$(GREEN)âœ… AnÃ¡lisis de calidad completado$(NC)"

lint:
	@echo "$(YELLOW)ğŸ”§ Ejecutando linter (flake8)...$(NC)"
	cd $(BACKEND_ROOT) && flake8 app tests --max-line-length=88 --exclude=__pycache__
	@echo "$(GREEN)âœ… Linting completado$(NC)"

format:
	@echo "$(YELLOW)ğŸ¨ Formateando cÃ³digo (black)...$(NC)"
	cd $(BACKEND_ROOT) && black app tests --line-length=88
	@echo "$(GREEN)âœ… Formateo completado$(NC)"

check-all: lint test quality
	@echo "$(GREEN)ğŸ‰ Â¡Todos los checks de calidad pasaron!$(NC)"

# ======================================
# ğŸ”„ INTEGRACIÃ“N TDD + CALIDAD
# ======================================
tdd-quality:
	@echo "$(YELLOW)ğŸš€ TDD + Calidad: Ejecutando ciclo completo...$(NC)"
	@make test
	@make quality
	@echo "$(GREEN)âœ… Ciclo TDD + Calidad completado$(NC)"

# ======================================
# ğŸ§¹ LIMPIEZA
# ======================================
clean:
	@echo "$(YELLOW)ğŸ§¹ Limpiando archivos temporales...$(NC)"
	find $(BACKEND_ROOT) -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find $(BACKEND_ROOT) -type f -name "*.pyc" -delete 2>/dev/null || true
	find $(BACKEND_ROOT) -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf $(BACKEND_ROOT)/.pytest_cache 2>/dev/null || true
	rm -rf $(BACKEND_ROOT)/htmlcov 2>/dev/null || true
	rm -rf $(BACKEND_ROOT)/.coverage 2>/dev/null || true
	rm -f quality_report.txt 2>/dev/null || true
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

# ======================================
# ğŸ¯ COMANDOS ESPECÃFICOS TDD
# ======================================
red:
	@echo "$(RED)ğŸ”´ RED: Ejecutando test que debe fallar...$(NC)"
	cd $(BACKEND_ROOT) && $(PYTEST) -v --tb=short || echo "$(RED)âœ… Test fallÃ³ como esperado (RED phase)$(NC)"

green:
	@echo "$(GREEN)ğŸŸ¢ GREEN: Ejecutando tests para pasar...$(NC)"
	cd $(BACKEND_ROOT) && $(PYTEST) -v
	@echo "$(GREEN)âœ… Tests pasaron (GREEN phase)$(NC)"

refactor: test quality
	@echo "$(YELLOW)ğŸ”„ REFACTOR: Tests + Calidad despuÃ©s de refactor...$(NC)"
	@echo "$(GREEN)âœ… Refactor validado$(NC)"

# ======================================
# ğŸ“Š REPORTES Y ANÃLISIS
# ======================================
tech-debt:
	@echo "$(YELLOW)ğŸ“Š Analizando deuda tÃ©cnica...$(NC)"
	cd $(BACKEND_ROOT) && $(PYTHON) infrastructure/scripts/tech_debt_analyzer.py
	@echo "$(GREEN)âœ… AnÃ¡lisis de deuda tÃ©cnica completado$(NC)"

report-json:
	@echo "$(YELLOW)ğŸ“‹ Generando reporte JSON...$(NC)"
	cd $(BACKEND_ROOT) && $(PYTHON) infrastructure/scripts/quality_checklist.py --format json --output quality_report.json
	@echo "$(GREEN)âœ… Reporte JSON generado$(NC)"

# ======================================
# ğŸš€ COMANDO PRINCIPAL INTEGRADO
# ======================================
dev: clean install test quality
	@echo "$(GREEN)ğŸ‰ Â¡Entorno de desarrollo listo!$(NC)"
	@echo "$(YELLOW)ğŸ“‹ PrÃ³ximos pasos:$(NC)"
	@echo "  - Ejecuta: make tdd (para desarrollo TDD)"
	@echo "  - Ejecuta: make quality (para check de calidad)"
	@echo "  - Ejecuta: make check-all (para validaciÃ³n completa)"
