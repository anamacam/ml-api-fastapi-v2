# ðŸš¨ ========= COPILOTO/CURSOR: PIPELINE DEPLOY VPS ========= ðŸš¨
#
# ðŸš€ PIPELINE DEDICADO DE DEPLOY VPS:
#    âœ… Deploy automÃ¡tico con validaciones
#    âœ… Rollback automÃ¡tico en caso de falla
#    âœ… Health checks post-deploy
#    âœ… Backup automÃ¡tico pre-deploy
#    âœ… Notificaciones de deploy
#
# ðŸš€ TRIGGERS:
#    âœ… Push a main: Deploy automÃ¡tico
#    âœ… Tags: Deploy de releases
#    âœ… Manual: Deploy controlado
#
# ðŸ“š REFERENCIA: /RULES.md secciÃ³n "ðŸ§  REGLAS PARA COPILOTO/CURSOR"
# 
# ================================================================

name: ðŸš€ Pipeline de Deploy VPS

on:
  # ðŸš€ Deploy automÃ¡tico en push a main y tags
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'infrastructure/**'
      - 'config/**'
  
  # ðŸ”§ Deploy manual con opciones
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_deploy:
        description: 'Forzar deploy (skip validations)'
        required: false
        default: false
        type: boolean
      create_backup:
        description: 'Crear backup antes del deploy'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  DEPLOY_TIMEOUT: '300'  # 5 minutes

jobs:
  
  # ======================================
  # ðŸ” PRE-DEPLOY VALIDATIONS
  # ======================================
  pre_deploy_validation:
    name: ðŸ” Validaciones Pre-Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.inputs.force_deploy != 'true'
    
    outputs:
      validation_passed: ${{ steps.validate.outputs.result }}
      
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ðŸ“¦ Install Validation Tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety detect-secrets yamllint
        
        # Install Docker for container validation
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        sudo usermod -aG docker $USER
    
    # ðŸ”’ Security validation
    - name: ðŸ”’ Security Validation
      run: |
        echo "ðŸ”’ Ejecutando validaciones de seguridad..."
        
        # Check for secrets
        detect-secrets scan --all-files --baseline .secrets.baseline
        
        # Security analysis
        bandit -r backend/app/ --severity-level medium --confidence-level medium
        
        # Dependency check
        safety check --file backend/requirements/base.txt
        
        echo "âœ… Validaciones de seguridad pasadas"
    
    # ðŸ§ª Quick test validation
    - name: ðŸ§ª Quick Test Validation
      run: |
        echo "ðŸ§ª Ejecutando tests crÃ­ticos..."
        
        cd backend
        pip install -r requirements/test.txt
        
        # Run critical tests only
        python -m pytest tests/unit/test_health.py -v
        python -m pytest tests/unit/test_main_app.py -v
        
        echo "âœ… Tests crÃ­ticos pasados"
    
    # ðŸ—ï¸ Build validation
    - name: ðŸ—ï¸ Build Validation
      run: |
        echo "ðŸ—ï¸ Validando build de Docker..."
        
        # Build backend container
        docker build -f infrastructure/docker/Dockerfile.backend -t ml-api-backend:test .
        
        # Build frontend container if exists
        if [ -f "infrastructure/docker/Dockerfile.frontend" ]; then
          docker build -f infrastructure/docker/Dockerfile.frontend -t ml-api-frontend:test .
        fi
        
        echo "âœ… Build validation pasada"
    
    - name: âœ… Set Validation Result
      id: validate
      run: |
        echo "result=passed" >> $GITHUB_OUTPUT
        echo "ðŸŽ‰ Todas las validaciones pre-deploy pasaron"

  # ======================================
  # ðŸ’¾ BACKUP PRE-DEPLOY
  # ======================================
  backup_production:
    name: ðŸ’¾ Backup ProducciÃ³n
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      (github.event.inputs.create_backup == 'true' || github.event.inputs.create_backup == '') &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    
    outputs:
      backup_id: ${{ steps.backup.outputs.backup_id }}
      
    steps:
    - name: ðŸ”§ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
    
    - name: ðŸ’¾ Create Backup
      id: backup
      run: |
        BACKUP_ID="backup_$(date +%Y%m%d_%H%M%S)_${GITHUB_SHA:0:8}"
        
        echo "ðŸ’¾ Creando backup: $BACKUP_ID"
        
        # Connect to VPS and create backup
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
          # Create backup directory
          mkdir -p /var/backups/ml-api/
          
          # Backup database
          if command -v pg_dump >/dev/null 2>&1; then
            pg_dump -h localhost -U \$DB_USER -d \$DB_NAME > /var/backups/ml-api/${BACKUP_ID}_database.sql
          fi
          
          # Backup application files
          tar -czf /var/backups/ml-api/${BACKUP_ID}_app.tar.gz -C /var/www/ml-api .
          
          # Backup configuration
          tar -czf /var/backups/ml-api/${BACKUP_ID}_config.tar.gz -C /etc/ml-api .
          
          echo "âœ… Backup creado: $BACKUP_ID"
        EOF
        
        echo "backup_id=$BACKUP_ID" >> $GITHUB_OUTPUT
        echo "âœ… Backup completado: $BACKUP_ID"

  # ======================================
  # ðŸš€ DEPLOY TO VPS
  # ======================================
  deploy_vps:
    name: ðŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [pre_deploy_validation, backup_production]
    if: |
      always() && 
      (needs.pre_deploy_validation.result == 'success' || 
       needs.pre_deploy_validation.result == 'skipped' ||
       github.event.inputs.force_deploy == 'true')
    
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    outputs:
      deploy_status: ${{ steps.deploy.outputs.status }}
      deploy_version: ${{ steps.deploy.outputs.version }}
      
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
    
    - name: ðŸš€ Deploy Application
      id: deploy
      run: |
        DEPLOY_VERSION="${GITHUB_SHA:0:8}"
        ENV="${{ github.event.inputs.environment || 'production' }}"
        
        echo "ðŸš€ Iniciando deploy a $ENV..."
        echo "ðŸ“¦ VersiÃ³n: $DEPLOY_VERSION"
        
        # Deploy to VPS
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
          set -e
          
          echo "ðŸ“¥ Actualizando cÃ³digo..."
          cd /var/www/ml-api
          
          # Pull latest changes
          git fetch origin
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }}
          
          echo "ðŸ Actualizando entorno Python..."
          cd backend
          source venv/bin/activate
          pip install -r requirements/base.txt
          
          echo "ðŸ“Š Ejecutando migraciones de DB..."
          python -m alembic upgrade head
          
          echo "ðŸ”„ Reiniciando servicios..."
          sudo systemctl restart ml-api-backend
          sudo systemctl restart nginx
          
          echo "â³ Esperando que los servicios inicien..."
          sleep 10
          
          echo "âœ… Deploy completado"
        EOF
        
        echo "status=success" >> $GITHUB_OUTPUT
        echo "version=$DEPLOY_VERSION" >> $GITHUB_OUTPUT
        
        echo "ðŸŽ‰ Deploy exitoso - VersiÃ³n: $DEPLOY_VERSION"
    
    - name: ðŸ“Š Post-Deploy Database Check
      run: |
        echo "ðŸ“Š Verificando estado de la base de datos..."
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          # Check database connectivity
          cd /var/www/ml-api/backend
          source venv/bin/activate
          python -c "
          from app.core.database import get_db
          try:
              db = next(get_db())
              print('âœ… Database connection OK')
          except Exception as e:
              print(f'âŒ Database error: {e}')
              exit(1)
          "
        EOF

  # ======================================
  # ðŸ¥ HEALTH CHECKS POST-DEPLOY
  # ======================================
  health_checks:
    name: ðŸ¥ Health Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: deploy_vps
    if: needs.deploy_vps.result == 'success'
    
    steps:
    - name: ðŸ¥ Application Health Check
      run: |
        echo "ðŸ¥ Verificando salud de la aplicaciÃ³n..."
        
        # Health check endpoint
        MAX_RETRIES=10
        RETRY_COUNT=0
        
        until curl -f -s "${{ secrets.VPS_URL }}/health" || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
          echo "â³ Intento $((RETRY_COUNT + 1))/$MAX_RETRIES - Esperando que la app responda..."
          sleep 30
          RETRY_COUNT=$((RETRY_COUNT + 1))
        done
        
        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "âŒ Health check fallÃ³ despuÃ©s de $MAX_RETRIES intentos"
          exit 1
        fi
        
        echo "âœ… Application health check passed"
    
    - name: ðŸŒ API Endpoints Check
      run: |
        echo "ðŸŒ Verificando endpoints de API..."
        
        # Check main API endpoints
        curl -f -s "${{ secrets.VPS_URL }}/api/v1/" || echo "âš ï¸ API v1 endpoint not available"
        
        # Check docs
        curl -f -s "${{ secrets.VPS_URL }}/docs" || echo "âš ï¸ Docs endpoint not available"
        
        echo "âœ… API endpoints check completed"
    
    - name: ðŸ”„ Service Status Check
      run: |
        echo "ðŸ”„ Verificando estado de servicios..."
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          # Check service status
          sudo systemctl is-active ml-api-backend || echo "âš ï¸ Backend service not active"
          sudo systemctl is-active nginx || echo "âš ï¸ Nginx service not active"
          sudo systemctl is-active postgresql || echo "âš ï¸ PostgreSQL service not active"
          
          echo "âœ… Service status check completed"
        EOF

  # ======================================
  # ðŸš¨ ROLLBACK EN CASO DE FALLA
  # ======================================
  rollback:
    name: ðŸš¨ Rollback
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy_vps, health_checks, backup_production]
    if: |
      always() && 
      (needs.deploy_vps.result == 'failure' || needs.health_checks.result == 'failure') &&
      needs.backup_production.outputs.backup_id != ''
    
    steps:
    - name: ðŸ”§ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
    
    - name: ðŸš¨ Execute Rollback
      run: |
        BACKUP_ID="${{ needs.backup_production.outputs.backup_id }}"
        
        echo "ðŸš¨ EJECUTANDO ROLLBACK..."
        echo "ðŸ“¦ Usando backup: $BACKUP_ID"
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
          set -e
          
          echo "ðŸ”„ Restaurando aplicaciÃ³n desde backup..."
          
          # Stop services
          sudo systemctl stop ml-api-backend
          
          # Restore application files
          cd /var/www/
          sudo rm -rf ml-api.old
          sudo mv ml-api ml-api.old
          sudo mkdir ml-api
          sudo tar -xzf /var/backups/ml-api/${BACKUP_ID}_app.tar.gz -C ml-api/
          
          # Restore database
          if [ -f "/var/backups/ml-api/${BACKUP_ID}_database.sql" ]; then
            psql -h localhost -U \$DB_USER -d \$DB_NAME < /var/backups/ml-api/${BACKUP_ID}_database.sql
          fi
          
          # Restart services
          sudo systemctl start ml-api-backend
          sudo systemctl restart nginx
          
          echo "âœ… Rollback completado"
        EOF
        
        echo "ðŸŽ‰ Rollback exitoso - Sistema restaurado"
    
    - name: ðŸš¨ Rollback Health Check
      run: |
        echo "ðŸ¥ Verificando salud post-rollback..."
        
        sleep 30
        
        if curl -f -s "${{ secrets.VPS_URL }}/health"; then
          echo "âœ… Rollback exitoso - AplicaciÃ³n funcionando"
        else
          echo "âŒ Rollback fallÃ³ - IntervenciÃ³n manual requerida"
          exit 1
        fi

  # ======================================
  # ðŸ“Š DEPLOY REPORT
  # ======================================
  deploy_report:
    name: ðŸ“Š Deploy Report
    runs-on: ubuntu-latest
    needs: [pre_deploy_validation, deploy_vps, health_checks, rollback]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Deploy Report
      run: |
        cat > deploy_report.md << 'EOF'
        # ðŸš€ Deploy Report
        
        ## ðŸ“Š Resumen
        - ðŸ• **Fecha**: $(date -u +"%Y-%m-%d %H:%M UTC")
        - ðŸŽ¯ **Entorno**: ${{ github.event.inputs.environment || 'production' }}
        - ðŸ“¦ **VersiÃ³n**: ${{ needs.deploy_vps.outputs.deploy_version || 'N/A' }}
        - ðŸ”§ **Trigger**: ${{ github.event_name }}
        
        ## ðŸ” Validaciones
        - ðŸ”’ **Seguridad**: ${{ needs.pre_deploy_validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed/Skipped' }}
        - ðŸ’¾ **Backup**: ${{ needs.backup_production.result == 'success' && 'âœ… Created' || 'âŒ Failed/Skipped' }}
        
        ## ðŸš€ Deploy
        - ðŸ“‹ **Status**: ${{ needs.deploy_vps.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}
        - ðŸ¥ **Health Checks**: ${{ needs.health_checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
        - ðŸš¨ **Rollback**: ${{ needs.rollback.result == 'success' && 'âš ï¸ Executed' || needs.rollback.result == 'skipped' && 'âž– Not Required' || 'âŒ Failed' }}
        
        ## ðŸ”— Enlaces
        - ðŸŒ **AplicaciÃ³n**: ${{ secrets.VPS_URL }}
        - ðŸ“š **Docs**: ${{ secrets.VPS_URL }}/docs
        - ðŸ¥ **Health**: ${{ secrets.VPS_URL }}/health
        EOF
        
        # Replace date placeholder
        sed -i "s/\$(date -u +\"%Y-%m-%d %H:%M UTC\")/$(date -u +"%Y-%m-%d %H:%M UTC")/g" deploy_report.md
        
        echo "ðŸ“Š Deploy Report generado"
        cat deploy_report.md
    
    - name: ðŸ“¤ Upload Deploy Report
      uses: actions/upload-artifact@v3
      with:
        name: deploy-report
        path: deploy_report.md
        retention-days: 90
    
    - name: ðŸš¨ Deploy Notification
      if: needs.deploy_vps.result == 'failure' || needs.rollback.result == 'success'
      run: |
        if [ "${{ needs.rollback.result }}" == "success" ]; then
          echo "ðŸš¨ ALERTA: Deploy fallÃ³ y se ejecutÃ³ rollback automÃ¡tico"
          echo "ðŸ” Revisar logs para identificar el problema"
        else
          echo "âŒ ALERTA: Deploy fallÃ³"
          echo "ðŸ” Revisar configuraciÃ³n y logs inmediatamente"
        fi 