name: ðŸŽ¯ Quality Pipeline - Tracking de Progreso

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # AnÃ¡lisis diario a las 9:00 AM
    - cron: '0 9 * * *'

jobs:
  quality-analysis:
    name: ðŸ“Š AnÃ¡lisis de Calidad
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para tracking histÃ³rico
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements/base.txt
        pip install radon flake8 bandit safety
    
    - name: ðŸ” Ejecutar anÃ¡lisis de deuda tÃ©cnica
      id: debt_analysis
      run: |
        cd backend
        python ../infrastructure/scripts/tech_debt_analyzer.py --format json > ../reports/current_debt.json
        echo "CURRENT_SCORE=$(python ../infrastructure/scripts/tech_debt_analyzer.py --format json | jq -r '.total_score')" >> $GITHUB_OUTPUT
    
    - name: ðŸ“‹ Verificar estÃ¡ndares
      run: |
        python infrastructure/scripts/check_standards.py --format json > reports/standards_report.json
    
    - name: ðŸ“ˆ Generar tracking de progreso
      id: progress_tracking
      run: |
        python infrastructure/scripts/progress_tracker.py
        echo "PROGRESS_MADE=$(cat reports/progress_summary.json | jq -r '.improvement')" >> $GITHUB_OUTPUT
        echo "TREND=$(cat reports/progress_summary.json | jq -r '.trend')" >> $GITHUB_OUTPUT
    
    - name: ðŸŽ¨ Generar dashboard de progreso
      run: |
        python infrastructure/scripts/generate_dashboard.py
    
    - name: ðŸ“¤ Subir reportes como artefactos
      uses: actions/upload-artifact@v3
      with:
        name: quality-reports-${{ github.sha }}
        path: |
          reports/current_debt.json
          reports/standards_report.json
          reports/progress_summary.json
          reports/dashboard.html
        retention-days: 30
    
    - name: ðŸš¨ Verificar umbrales de calidad
      run: |
        SCORE=${{ steps.debt_analysis.outputs.CURRENT_SCORE }}
        if (( $(echo "$SCORE < 60.0" | bc -l) )); then
          echo "âŒ CRÃTICO: Score $SCORE estÃ¡ por debajo del umbral mÃ­nimo (60)"
          exit 1
        elif (( $(echo "$SCORE < 70.0" | bc -l) )); then
          echo "âš ï¸ ADVERTENCIA: Score $SCORE necesita mejoras (target: 70+)"
        elif (( $(echo "$SCORE < 80.0" | bc -l) )); then
          echo "ðŸ“ˆ BUENO: Score $SCORE estÃ¡ mejorando (target: 80+)"
        else
          echo "ðŸŽ‰ EXCELENTE: Score $SCORE estÃ¡ en rango Ã³ptimo!"
        fi
    
    - name: ðŸ’¬ Comentar en PR con progreso
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const score = '${{ steps.debt_analysis.outputs.CURRENT_SCORE }}';
          const progress = '${{ steps.progress_tracking.outputs.PROGRESS_MADE }}';
          const trend = '${{ steps.progress_tracking.outputs.TREND }}';
          
          let emoji = 'ðŸ“ˆ';
          if (trend === 'improving') emoji = 'ðŸš€';
          else if (trend === 'declining') emoji = 'ðŸ“‰';
          
          const comment = `## ${emoji} Quality Progress Report
          
          **Current Score:** ${score}/100
          **Progress:** ${progress}
          **Trend:** ${trend}
          
          ### ðŸ“Š Quality Breakdown
          - ðŸŽ¯ **Target Score:** 85+
          - ðŸ“ˆ **Current Status:** ${score >= 80 ? 'ðŸŸ¢ Excellent' : score >= 70 ? 'ðŸŸ¡ Good' : 'ðŸ”´ Needs Improvement'}
          
          ### ðŸ”— Full Reports
          Check the [Quality Dashboard](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed metrics.
          
          ${score < 70 ? 'âš ï¸ **Action Required:** Score below recommended threshold' : ''}
          ${progress.includes('+') ? 'ðŸŽ‰ **Great Job!** Quality is improving!' : ''}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  celebrate-improvements:
    name: ðŸŽ‰ Celebrar Mejoras
    runs-on: ubuntu-latest
    needs: quality-analysis
    if: contains(needs.quality-analysis.outputs.TREND, 'improving')
    
    steps:
    - name: ðŸŽŠ Reconocer mejoras de calidad
      run: |
        echo "ðŸŽ‰ Â¡Excelente trabajo! La calidad del cÃ³digo estÃ¡ mejorando."
        echo "ðŸš€ Score actual: ${{ needs.quality-analysis.outputs.CURRENT_SCORE }}"
        echo "ðŸ“ˆ Tendencia: ${{ needs.quality-analysis.outputs.TREND }}" 