# ðŸš¨ ========= COPILOTO/CURSOR: PIPELINE SEGURIDAD AVANZADA ========= ðŸš¨
#
# ðŸ”’ PIPELINE DEDICADO DE SEGURIDAD VPS:
#    âœ… AnÃ¡lisis profundo de vulnerabilidades
#    âœ… Escaneo de dependencias crÃ­ticas
#    âœ… ValidaciÃ³n de configuraciones de servidor
#    âœ… AnÃ¡lisis de superficie de ataque
#    âœ… Reportes de seguridad automatizados
#
# ðŸš€ TRIGGERS:
#    âœ… Schedule: Diario y semanal
#    âœ… Manual: Para auditorÃ­as especÃ­ficas
#    âœ… Push a main: ValidaciÃ³n crÃ­tica
#
# ðŸ“š REFERENCIA: /RULES.md secciÃ³n "ðŸ§  REGLAS PARA COPILOTO/CURSOR"
# 
# ================================================================

name: ðŸ”’ Pipeline de Seguridad Avanzada

on:
  # â° Escaneos programados
  schedule:
    - cron: '0 6 * * *'    # Daily at 6 AM
    - cron: '0 2 * * 0'    # Weekly on Sunday at 2 AM
  
  # ðŸš€ Push a ramas crÃ­ticas
  push:
    branches: [ main, master ]
    paths:
      - 'backend/app/**'
      - 'backend/requirements/**'
      - 'config/**'
      - 'infrastructure/**'
  
  # ðŸ”§ Trigger manual para auditorÃ­as
  workflow_dispatch:
    inputs:
      scan_depth:
        description: 'Profundidad del escaneo'
        required: true
        default: 'standard'
        type: choice
        options:
        - standard
        - deep
        - critical

env:
  PYTHON_VERSION: '3.11'

jobs:
  
  # ======================================
  # ðŸ” ANÃLISIS DE SUPERFICIE DE ATAQUE
  # ======================================
  attack_surface_analysis:
    name: ðŸŽ¯ AnÃ¡lisis Superficie de Ataque
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # ðŸ” Analizar endpoints expuestos
    - name: ðŸŒ Endpoint Analysis
      run: |
        mkdir -p reports/security
        echo "ðŸ” Analizando endpoints expuestos..."
        
        # Buscar definiciones de rutas FastAPI
        echo "## ðŸŒ Endpoints Expuestos" > reports/security/attack_surface.md
        echo "" >> reports/security/attack_surface.md
        
        grep -r "@app\." backend/app/ --include="*.py" | \
        sed 's/.*@app\.\([^(]*\)(\([^)]*\)).*/- **\1**: \2/' >> reports/security/attack_surface.md || true
        
        # Buscar configuraciones de CORS
        echo "" >> reports/security/attack_surface.md
        echo "## ðŸŒ ConfiguraciÃ³n CORS" >> reports/security/attack_surface.md
        grep -r "CORSMiddleware\|allow_origins" backend/app/ --include="*.py" >> reports/security/attack_surface.md || true
    
    # ðŸ” Analizar configuraciones de seguridad
    - name: ðŸ›¡ï¸ Security Configuration Analysis
      run: |
        echo "ðŸ” Analizando configuraciones de seguridad..."
        
        echo "" >> reports/security/attack_surface.md
        echo "## ðŸ”’ Configuraciones de Seguridad" >> reports/security/attack_surface.md
        
        # Buscar configuraciones de autenticaciÃ³n
        grep -r "SECRET\|JWT\|AUTH\|PASSWORD" config/ --include="*.env" | \
        grep -v "example" >> reports/security/attack_surface.md || true
        
        # Analizar middlewares de seguridad
        grep -r "middleware\|Security" backend/app/ --include="*.py" >> reports/security/attack_surface.md || true
    
    - name: ðŸ“¤ Upload Attack Surface Report
      uses: actions/upload-artifact@v3
      with:
        name: attack-surface-analysis
        path: reports/security/attack_surface.md
        retention-days: 90

  # ======================================
  # ðŸš« ANÃLISIS AVANZADO DE VULNERABILIDADES
  # ======================================
  vulnerability_scan:
    name: ðŸš« Escaneo de Vulnerabilidades
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ðŸ“¦ Install Security Tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety semgrep pip-audit vulners
        
        # Install additional security scanners
        sudo apt-get update
        sudo apt-get install -y nmap sqlmap
    
    # ðŸ—ï¸ Bandit - Python security analysis
    - name: ðŸ Python Security Analysis (Bandit)
      run: |
        mkdir -p reports/security
        echo "ðŸ” Ejecutando anÃ¡lisis de seguridad Python..."
        
        bandit -r backend/app/ \
          -f json -o reports/security/bandit_detailed.json \
          -f txt -o reports/security/bandit_summary.txt \
          --severity-level medium \
          --confidence-level medium || true
        
        # Mostrar resumen crÃ­tico
        bandit -r backend/app/ --severity-level high --confidence-level high || true
    
    # ðŸ“¦ Safety - Dependency vulnerabilities
    - name: ðŸ“¦ Dependency Vulnerability Scan
      run: |
        echo "ðŸ“¦ Escaneando vulnerabilidades en dependencias..."
        
        safety check \
          --json --output reports/security/safety_detailed.json \
          --file backend/requirements/base.txt || true
        
        safety check \
          --file backend/requirements/base.txt || true
        
        # pip-audit for additional coverage
        pip-audit --format=json --output=reports/security/pip_audit.json || true
        pip-audit || true
    
    # ðŸ”¬ Semgrep - Static analysis
    - name: ðŸ”¬ Static Code Analysis (Semgrep)
      run: |
        echo "ðŸ”¬ Ejecutando anÃ¡lisis estÃ¡tico avanzado..."
        
        # Security-focused rules
        semgrep --config=security backend/app/ \
          --json --output=reports/security/semgrep_security.json || true
        
        # Performance issues
        semgrep --config=performance backend/app/ \
          --json --output=reports/security/semgrep_performance.json || true
        
        # Show critical findings
        semgrep --config=security backend/app/ --severity=ERROR || true
    
    # ðŸŒ Network security analysis
    - name: ðŸŒ Network Security Analysis
      if: github.event.inputs.scan_depth == 'deep' || github.event.inputs.scan_depth == 'critical'
      run: |
        echo "ðŸŒ Analizando configuraciones de red..."
        
        # Analyze Docker configurations
        if [ -f "infrastructure/docker/docker-compose.yml" ]; then
          echo "## ðŸ³ Docker Security" > reports/security/network_analysis.md
          grep -i "port\|expose\|network" infrastructure/docker/docker-compose.yml >> reports/security/network_analysis.md || true
        fi
        
        # Analyze Nginx configurations
        if [ -d "infrastructure/nginx" ]; then
          echo "" >> reports/security/network_analysis.md
          echo "## ðŸŒ Nginx Security" >> reports/security/network_analysis.md
          grep -i "ssl\|tls\|secure\|header" infrastructure/nginx/*.conf >> reports/security/network_analysis.md || true
        fi
    
    - name: ðŸ“¤ Upload Vulnerability Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: vulnerability-reports
        path: reports/security/
        retention-days: 90

  # ======================================
  # ðŸ“Š REPORTE DE SEGURIDAD CONSOLIDADO
  # ======================================
  security_report:
    name: ðŸ“Š Reporte de Seguridad
    runs-on: ubuntu-latest
    needs: [attack_surface_analysis, vulnerability_scan]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ“¥ Download Security Reports
      uses: actions/download-artifact@v3
      with:
        name: attack-surface-analysis
        path: reports/attack-surface/
    
    - name: ðŸ“¥ Download Vulnerability Reports
      uses: actions/download-artifact@v3
      with:
        name: vulnerability-reports
        path: reports/vulnerabilities/
    
    - name: ðŸ“Š Generate Security Dashboard
      run: |
        echo "ðŸ“Š Generando dashboard de seguridad..."
        
        cat > reports/security_dashboard.md << 'EOF'
        # ðŸ”’ Dashboard de Seguridad VPS
        
        ## ðŸ“Š Resumen Ejecutivo
        - ðŸ• **Fecha**: $(date -u +"%Y-%m-%d %H:%M UTC")
        - ðŸŽ¯ **Superficie de Ataque**: Analizada
        - ðŸš« **Vulnerabilidades**: Escaneadas
        - ðŸ“¦ **Dependencias**: Validadas
        
        ## ðŸŽ¯ Superficie de Ataque
        - âœ… Endpoints expuestos catalogados
        - âœ… Configuraciones CORS validadas
        - âœ… Middlewares de seguridad verificados
        
        ## ðŸš« Vulnerabilidades
        - ðŸ“‹ **Bandit**: AnÃ¡lisis de cÃ³digo Python
        - ðŸ“¦ **Safety**: Dependencias vulnerables
        - ðŸ”¬ **Semgrep**: AnÃ¡lisis estÃ¡tico
        - ðŸŒ **Network**: Configuraciones de red
        
        ## ðŸš€ Acciones Recomendadas
        1. ðŸ“‹ Revisar reportes detallados en artifacts
        2. ðŸ”§ Priorizar vulnerabilidades HIGH/CRITICAL
        3. ðŸ“¦ Actualizar dependencias vulnerables
        4. ðŸ”’ Implementar controles de seguridad faltantes
        
        ## ðŸ“š Referencias
        - ðŸ“– [OWASP Top 10](https://owasp.org/www-project-top-ten/)
        - ðŸ›¡ï¸ [Python Security Guide](https://python-security.readthedocs.io/)
        - ðŸ”’ [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
        EOF
        
        # Replace date placeholder
        sed -i "s/\$(date -u +\"%Y-%m-%d %H:%M UTC\")/$(date -u +"%Y-%m-%d %H:%M UTC")/g" reports/security_dashboard.md
    
    - name: ðŸ“§ Security Alert (if Critical)
      if: contains(github.event.head_commit.message, 'CRITICAL') || github.event.inputs.scan_depth == 'critical'
      run: |
        echo "ðŸš¨ ALERTA DE SEGURIDAD CRÃTICA DETECTADA"
        echo "ðŸ“‹ Revisar inmediatamente los reportes de seguridad"
        echo "ðŸ”— Artifacts disponibles en: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    
    - name: ðŸ“¤ Upload Security Dashboard
      uses: actions/upload-artifact@v3
      with:
        name: security-dashboard
        path: reports/security_dashboard.md
        retention-days: 180 